import os, csv
import ghpythonlib.treehelpers as th
import scriptcontext as sc

def sanitize_path(p):
    """æ¸…ç†æ–‡ä»¶è·¯å¾„"""
    if p is None:
        return ""
    s = str(p).replace("\r", "").replace("\n", "").strip().strip('"').strip("'")
    return os.path.normpath(s)

def flatten_strict(x):
    """æŠŠåµŒå¥— list/tuple å‹å¹³æˆä¸€ç»´åˆ—è¡¨"""
    if isinstance(x, (list, tuple)):
        flat = []
        for i in x:
            flat.extend(flatten_strict(i))
        return flat
    else:
        return [x]

# -------- ä¸»é€»è¾‘ --------
Path = None
Row_out = []

if Run and File:
    # âš ï¸ battery1 å·²å®Œæˆæ—¶ä¸å†å†™å…¥
    if sc.sticky.get("lhs_done", False):
        Path = None
        Row_out = []
    else:
        base = sanitize_path(File)

        if base:
            # ç”Ÿæˆ CSV è·¯å¾„
            if base.lower().endswith(".csv"):
                csv_path = base
                folder = os.path.dirname(csv_path)
            else:
                folder = base
                csv_path = os.path.join(folder, "LHS_output.csv")

            if folder and not os.path.exists(folder):
                os.makedirs(folder)

            # ğŸŸ¢ è½¬æ¢ DataTree ä¸º list
            try:
                Row_py = th.tree_to_list(Row)
            except:
                Row_py = Row

            Row_out = flatten_strict(Row_py)

            # ğŸ§  ä½¿ç”¨ sticky ä¿å­˜æ ·æœ¬ç¼–å·
            if "sample_id" not in sc.sticky:
                sc.sticky["sample_id"] = 1
            else:
                sc.sticky["sample_id"] += 1
            sample_id = sc.sticky["sample_id"]

            # ğŸ“ å†™å…¥ CSV
            write_header = not os.path.exists(csv_path)
            with open(csv_path, "a", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                if write_header:
                    header = ["Sample"] + ["Col{}".format(i + 1) for i in range(len(Row_out))]
                    w.writerow(header)
                w.writerow([sample_id] + Row_out)

            Path = csv_path
else:
    Path = None

# è¾“å‡º
Path = Path
Row = Row_out
