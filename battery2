"""
This GHPython component appends each LHS sample (row) to a CSV file during iteration.
- Accepts a base folder or a full CSV file path.
- Converts incoming data (including DataTree) into a flat row.
- Automatically generates sample IDs.
- Writes a header on the first run, appends data in subsequent runs.
- Uses sticky context to track sample count and avoid writing after completion.
"""

import os, csv
import ghpythonlib.treehelpers as th
import scriptcontext as sc

def sanitize_path(p):
    """Clean up a file/folder path string."""
    if p is None:
        return ""
    s = str(p).replace("\r", "").replace("\n", "").strip().strip('"').strip("'")
    return os.path.normpath(s)

def flatten_strict(x):
    """Flatten nested lists/tuples into a flat list."""
    if isinstance(x, (list, tuple)):
        flat = []
        for i in x:
            flat.extend(flatten_strict(i))
        return flat
    else:
        return [x]

# -------- Main Logic --------
Path = None
Row_out = []

if Run and File:
    # Do not write if upstream component has completed sampling
    if sc.sticky.get("lhs_done", False):
        Path = None
        Row_out = []
    else:
        base = sanitize_path(File)

        if base:
            # Determine CSV file path
            if base.lower().endswith(".csv"):
                csv_path = base
                folder = os.path.dirname(csv_path)
            else:
                folder = base
                csv_path = os.path.join(folder, "LHS_output.csv")

            if folder and not os.path.exists(folder):
                os.makedirs(folder)

            # Convert DataTree or input to flat list
            try:
                Row_py = th.tree_to_list(Row)
            except:
                Row_py = Row

            Row_out = flatten_strict(Row_py)

            # Maintain sample ID using sticky storage
            if "sample_id" not in sc.sticky:
                sc.sticky["sample_id"] = 1
            else:
                sc.sticky["sample_id"] += 1
            sample_id = sc.sticky["sample_id"]

            # Append data to CSV file
            write_header = not os.path.exists(csv_path)
            with open(csv_path, "a", newline="", encoding="utf-8") as f:
                w = csv.writer(f)
                if write_header:
                    header = ["Sample"] + ["Col{}".format(i + 1) for i in range(len(Row_out))]
                    w.writerow(header)
                w.writerow([sample_id] + Row_out)

            Path = csv_path
else:
    Path = None

# Outputs
Path = Path
Row = Row_out
